<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub + Firebase ブログ</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* スタイルは前回と同じ */
        body {
            font-family: 'Nunito Sans', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f6fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        header {
            background: #2a2d34;
            color: white;
            padding: 1rem 0;
            text-align: center;
        }
        form {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            background: #5b5fd6;
        }
        .post-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .post-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .comment-section {
            margin-top: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
        }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.9rem; }
        .italic { font-style: italic; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <header>
        <h1>GitHub + Firebase ブログ</h1>
    </header>

    <div class="container">
        <!-- 記事投稿フォーム（管理者用トークン入力含む） -->
        <form id="postForm">
            <div class="mb-4">
                <label for="title">タイトル</label>
                <input type="text" id="title" required>
            </div>
            <div class="mb-4">
                <label for="content">本文</label>
                <textarea id="content" rows="6" required></textarea>
            </div>
            <div class="mb-4">
                <label for="githubToken">GitHub Personal Access Token（管理者のみ）</label>
                <input type="password" id="githubToken" required>
            </div>
            <button type="submit">記事を投稿</button>
        </form>

        <!-- 記事一覧 -->
        <div class="post-list" id="postList"></div>

        <!-- コメントセクション -->
        <div class="comment-section hidden" id="commentsContainer">
            <h2 id="postTitle"></h2>
            <div id="commentList"></div>
            <div class="mt-4">
                <input type="text" id="newComment" placeholder="コメントを追加..." class="w-full p-2 rounded border">
                <button id="addComment" class="mt-2 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">コメントを投稿</button>
            </div>
            <div class="mt-4 text-center">
                <button id="likeButton" class="text-lg hover:text-red-500">
                    <span id="likeCount">0</span> いいね
                </button>
            </div>
        </div>
    </div>

    <!-- 依存ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>

    <script>
        // あなたの設定
        const REPO_OWNER = 'riku-tatuto'; // GitHubアカウント名
        const REPO_NAME = 'test-blog'; // リポジトリ名
        const POSTS_PATH = '/_posts/';

        const firebaseConfig = {
            apiKey: "AIzaSyACaRzcxYiSnko-L0cemRaT_SYRHjOi8tY",
            authDomain: "online-chat-5daf8.firebaseapp.com",
            databaseURL: "https://online-chat-5daf8-default-rtdb.firebaseio.com",
            projectId: "online-chat-5daf8",
            storageBucket: "online-chat-5daf8.firebasestorage.app",
            messagingSenderId: "499641724634",
            appId: "1:499641724634:web:6da05eb79bea5893aaffe3"
        };

        // Firebase初期化
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        firebase.auth().signInAnonymously();

        // 記事投稿処理
        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const githubToken = document.getElementById('githubToken').value;

            if (!title || !content || !githubToken) {
                alert('すべての項目を入力してください');
                return;
            }

            try {
                await createGitHubFile(title, content, githubToken);
                document.getElementById('title').value = '';
                document.getElementById('content').value = '';
                document.getElementById('githubToken').value = '';
            } catch (error) {
                console.error(error);
                alert('投稿に失敗しました');
            }
        });

        // GitHubファイル作成（トークン毎回指定）
        async function createGitHubFile(title, content, token) {
            const formattedDate = new Date().toISOString().slice(0,10);
            const filename = `${formattedDate}-${title.replace(/ /g, '-')}.md`;
            const path = POSTS_PATH + filename;
            const encodedContent = btoa(`---
title: ${title}
---
${content}`);

            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `New post: ${title}`,
                    content: encodedContent
                })
            });

            if (!response.ok) {
                throw new Error('GitHub APIエラー: ' + response.statusText);
            }
        }

        // 記事一覧取得（変更なし）
        async function loadPosts() {
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents${POSTS_PATH}`);
            const files = await response.json();

            const postList = document.getElementById('postList');
            postList.innerHTML = '';

            files.forEach(file => {
                const filename = file.name.replace(/\.md$/, '');
                const date = filename.slice(0,10);
                const title = filename.slice(11).replace(/-/g, ' ');

                const postEl = document.createElement('div');
                postEl.className = 'post-card';
                postEl.innerHTML = `
                    <h3>${title}</h3>
                    <p class="text-sm italic">${date}</p>
                    <button class="view-btn mt-2 bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">詳細を見る</button>
                `;

                postEl.querySelector('.view-btn').addEventListener('click', () => viewPost(file.download_url));
                postList.appendChild(postEl);
            });
        }

        // 記事詳細表示（変更なし）
        async function viewPost(url) {
            const response = await fetch(url);
            const content = await response.text();
            const htmlContent = marked.parse(content.split('\n').slice(3).join('\n'));

            document.getElementById('postTitle').textContent = getTitleFromContent(content);
            document.getElementById('postContent').innerHTML = htmlContent;
            document.getElementById('commentsContainer').classList.remove('hidden');
            loadComments(url);
            loadLikes(url);
        }

        function getTitleFromContent(content) {
            const match = content.match(/title:\s*(.*)/);
            return match ? match[1] : 'タイトルなし';
        }

        // コメント管理（変更なし）
        function loadComments(postUrl) {
            const commentsRef = database.ref(`comments/${encodeURIComponent(postUrl)}`);
            commentsRef.on('value', (snapshot) => {
                const commentList = document.getElementById('commentList');
                commentList.innerHTML = '';
                
                snapshot.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment';
                    commentEl.textContent = comment.val();
                    commentList.appendChild(commentEl);
                });
            });
        }

        document.getElementById('addComment').addEventListener('click', () => {
            const comment = document.getElementById('newComment').value;
            if (!comment) return;

            const commentsRef = database.ref(`comments/${encodeURIComponent(currentPostUrl)}`);
            commentsRef.push(comment);
            document.getElementById('newComment').value = '';
        });

        // いいね管理（変更なし）
        let currentPostUrl;
        let likeRef;

        function loadLikes(postUrl) {
            currentPostUrl = postUrl;
            likeRef = database.ref(`likes/${encodeURIComponent(postUrl)}`);
            
            likeRef.on('value', (snapshot) => {
                const count = snapshot.val() || 0;
                document.getElementById('likeCount').textContent = count;
            });
        }

        document.getElementById('likeButton').addEventListener('click', () => {
            likeRef.transaction(current => (current || 0) + 1);
        });

        // 初期ロード
        loadPosts();
    </script>
</body>
</html>
