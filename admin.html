<!DOCTYPE html>
<html>
<head>
    <title>Admin - Test Blog</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/octokit@2.0.10/build/octokit.min.js"></script>
</head>
<body>
    <div class="admin-container">
        <h1>記事投稿</h1>
        <form id="postForm">
            <input type="text" id="token" placeholder="GitHub Personal Access Token" required>
            <input type="text" id="slug" placeholder="記事URLスラグ" required>
            <input type="text" id="title" placeholder="記事タイトル" required>
            <textarea id="content" placeholder="Markdown形式でコンテンツを入力..." required></textarea>
            <button type="submit">投稿する</button>
        </form>
    </div>

    <script>
        document.getElementById('postForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = document.getElementById('token').value;
            const slug = document.getElementById('slug').value;
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            
            const octokit = new Octokit({ accessToken: token });
            const owner = 'riku-tatuto';
            const repo = 'test-blog';

            try {
                // 記事Markdownファイル作成
                const markdownContent = `# ${title}\n\n${content}`;
                await octokit.repos.createOrUpdateFileContents({
                    owner, repo,
                    path: `posts/${slug}.md`,
                    message: `Add ${slug} post`,
                    content: btoa(unescape(encodeURIComponent(markdownContent)))
                });

                // posts.json更新
                let posts = [];
                try {
                    const { data } = await octokit.repos.getContent({
                        owner, repo, path: 'posts.json'
                    });
                    const response = await fetch(data.download_url);
                    posts = await response.json();
                } catch (e) {
                    console.log('posts.jsonが見つかりません');
                }

                posts.push({
                    slug, 
                    title, 
                    date: new Date().toISOString()
                });

                await octokit.repos.createOrUpdateFileContents({
                    owner, repo,
                    path: 'posts.json',
                    message: 'Update posts.json',
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(posts, null, 2))))
                });

                alert('投稿が完了しました！');
                document.getElementById('postForm').reset();
            } catch (error) {
                console.error('エラー:', error);
                alert('投稿に失敗しました。');
            }
        });
    </script>
</body>
</html>
